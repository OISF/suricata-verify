requires:
  min-version: 9

args:
  - -k none --set stream.inline=true

pcap: ../detect-email-received/input.pcap

checks:
- filter:
    count: 1
    match:
      event_type: smtp
      email.received[0]: "from client.local (client.local [10.0.0.1]) by smtp.relay1.com with ESMTP id relay1abc; Thu, 10 Apr 2025 12:00:00 -0000"
      email.received[1]: "from smtp.relay1.com (smtp.relay1.com [10.0.0.10]) by smtp.relay2.com with ESMTP id relay2xyz; Thu, 10 Apr 2025 12:01:00 -0000"
      email.received[2]: "from smtp.relay2.com (smtp.relay2.com [10.0.0.20]) by smtp.destination.com with ESMTP id final123; Thu, 10 Apr 2025 12:02:00 -0000"
- filter:
    count: 1
    match:
      event_type: smtp
      email.received.__len: 3
- filter:
    count: 1
    match:
      event_type: alert
      alert.signature_id: 10
      # we do not have a way to log email.received in alerts
      # see https://redmine.openinfosecfoundation.org/issues/7696
- filter:
    count: 1
    match:
      event_type: alert
      alert.signature_id: 11
- filter:
    count: 0
    match:
      event_type: alert
      alert.signature_id: 20
- filter:
    count: 0
    match:
      event_type: alert
      alert.signature_id: 21

- filter:
    count: 1
    match:
      event_type: alert
      alert.signature_id: 30
- filter:
    count: 1
    match:
      event_type: alert
      alert.signature_id: 31
- filter:
    count: 1
    match:
      event_type: alert
      alert.signature_id: 32
