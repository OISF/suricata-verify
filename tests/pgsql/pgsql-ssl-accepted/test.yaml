requires:
  # Requires minimum version 7.0
  min-version: 7.0

args:
- -k none

checks:
- filter:
    count: 1
    match:
      dest_ip: 192.168.50.11
      dest_port: 60358
      event_type: pgsql
      pgsql.request.message: SSL Request
      pgsql.response.message: SSL Accepted
      pgsql.tx_id: 1
      proto: TCP
      src_ip: 192.168.50.12
      src_port: 5432
- filter:
    count: 1
    match:
      dest_ip: 192.168.50.12
      dest_port: 5432
      event_type: tls
      pcap_cnt: 10
      proto: TCP
      src_ip: 192.168.50.11
      src_port: 60358
      tls.from_proto: pgsql
      tls.issuerdn: CN=ubuntu
      tls.subject: CN=ubuntu
- filter:
    count: 1
    match:
      app_proto: tls
      app_proto_orig: pgsql
      dest_ip: 192.168.50.12
      dest_port: 5432
      event_type: flow
      flow.age: 0
      flow.alerted: false
      flow.bytes_toclient: 2220
      flow.bytes_toserver: 1250
      flow.pkts_toclient: 7
      flow.pkts_toserver: 9
      flow.reason: shutdown
      flow.state: closed
      proto: TCP
      src_ip: 192.168.50.11
      src_port: 60358
      tcp.ack: true
      tcp.psh: true
      tcp.rst: true
      tcp.state: closed
      tcp.syn: true
      tcp.tcp_flags: 1e
      tcp.tcp_flags_tc: 1a
      tcp.tcp_flags_ts: 1e
- filter:
    count: 1
    match:
      dest_ip: 192.168.50.11
      dest_port: 60359
      event_type: pgsql
      pgsql.request.startup_message.protocol_version: '3.0'
      pgsql.request.startup_message.startup_parameters.database: replication
      pgsql.request.startup_message.startup_parameters.user: rep
      pgsql.response.error_response.message_body.code: '28000'
      pgsql.response.error_response.message_body.file: auth.c
      pgsql.response.error_response.message_body.line: '481'
      pgsql.response.error_response.message_body.message: no pg_hba.conf entry for
        replication connection from host "192.168.50.11", user "rep", SSL off
      pgsql.response.error_response.message_body.routine: ClientAuthentication
      pgsql.response.error_response.message_body.severity: FATAL
      pgsql.tx_id: 1
      proto: TCP
      src_ip: 192.168.50.12
      src_port: 5432
- filter:
    count: 1
    match:
      app_proto: pgsql
      dest_ip: 192.168.50.12
      dest_port: 5432
      event_type: flow
      flow.age: 0
      flow.alerted: false
      flow.bytes_toclient: 357
      flow.bytes_toserver: 291
      flow.pkts_toclient: 3
      flow.pkts_toserver: 3
      flow.reason: shutdown
      flow.state: established
      proto: TCP
      src_ip: 192.168.50.11
      src_port: 60359
      tcp.ack: true
      tcp.psh: true
      tcp.state: established
      tcp.syn: true
      tcp.tcp_flags: 1a
      tcp.tcp_flags_tc: 1a
      tcp.tcp_flags_ts: 1a
